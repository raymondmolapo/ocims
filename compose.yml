#
# !!! NB: THIS FILE IS AUTO-GENERATED BY setup.py PROGRAM !!!
#
# Created by: {{ general.user or "Derek Hohls" }}
# Created on: {{ general.date }}
# Purpose:
#    Setup Dockers for a CKAN deployment
# See:
#    https://www.calazan.com/using-docker-and-docker-compose-for-local-django-development-replacing-virtualenv/
# Notes:
#    * 'image' is a reference to a DockerHub location e.g.
#      cheewai/postgis refers to https://hub.docker.com/r/cheewai/postgis/
#    * if all containers are DISABLED, this file will throw an error!
{% if no_postgresql %}
# postgresql DISABLED
{% else %}
postgresql:
    image: {{ postgresql.image or "raymondmolapo/postgis" }}
    container_name: {{ postgresql.container_name or "ocims_postgis" }}
    environment:
        - POSTGRES_DB={{ postgresql.database or "ckan_default" }}
        - POSTGRES_USER={{ postgresql.user or "ckan" }}
        - POSTGRES_PASSWORD={{ postgresql.password }}
    volumes:
        - {{ postgresql.data or "~/postgresql/data/" }}:/var/lib/postgresql/data
        # Customize access control to overwrite the default
        #- ~/dev/ocims/postgresql/pg_hba.conf:/var/lib/postgresql/data/pg_hba.conf:ro
        # Customize server tuning parameters to overwrite the default
        #- ~/dev/ocims/postgresql/postgresql.conf:/var/lib/postgresql/data/postgresql.conf:ro
    ports:
        - "{{ postgresql.port or "5431" }}:5432"
{% endif %}
{% if no_tomcat %}
# tomcat DISABLED
{% else %}
tomcat:
    image: {{ tomcat.image or "tomcat:8-jre8" }}
    container_name: {{ tomcat.container_name or "ocims_tomcat" }}
    volumes:
        - {{ tomcat.volume or "~/tomcat/webapps" }}:/usr/local/tomcat/webapps/
    ports:
        - "{{ tomcat.port or "8081" }}:8080"
{% endif %}
{% if no_solr %}
# solr DISABLED
{% else %}
solr:
    image: {{ solr.image or "solr" }}
    container_name: {{ solr.container_name or "ocims_solr" }}
    # command used to trigger create:
    # https://github.com/docker-solr/docker-solr/blob/master/5.3/scripts/docker-entrypoint.sh
    command: solr-precreate ckan {{ solr.conf_out or "/var/solr/data/configsets/ckan/" }}
    #environment:
    #    - CKAN_POSTGRESQL_PASSWORD
    # mount in schema, see: 
    # http://docs.ckan.org/en/latest/maintaining/installing/install-from-source.html#setup-solr
    volumes:
        - {{ solr.backup or "~/solr/backup/" }}:/solr/backup/
        - {{ solr.conf_in or "~/ckan/"}}:{{ solr.conf_out or "/var/solr/data/configsets/ckan/" }}
        - jts-1.13.jar:/opt/solr/server/lib/jts-1.13.jar
    #    - {{ solr.volume or "~/solr/" }}:/usr/local/solr/webapps/
    ports:
        - "{{ solr.port or "8981" }}:8983"
{% endif %}
{% if no_ckan == True %}
# ckan DISABLED
{% else %}
ckan:
    build: ckan
    container_name: {{ ckan.container_name or "ocims_ckan" }}
    #command:
    #    /usr/sbin/apache2ctl -D FOREGROUND
    volumes:
        - {{ ckan.scripts or "~/scripts" }}:/scripts
        - {{ solr.schema or "~/ckan/conf/schema.xml"}}:/usr/lib/ckan/default/src/ckan/ckan/config/solr/schema.xml
    # Note: must set by -  export CKAN_POSTGRESQL_PASSWORD="foo"
    environment:
        - CKAN_POSTGRESQL_PASSWORD=$CKAN_POSTGRESQL_PASSWORD
    ports:
        - "{{ ckan.port or "80" }}:80"
{% endif %}

