#
# !!! NB: THIS FILE IS AUTO-GENERATED BY setup.py PROGRAM !!!
#
# Created by: DerekH
# Created on: 2016-12-12
# Purpose:
#    Setup Dockers for a CKAN deployment
# See:
#    https://www.calazan.com/using-docker-and-docker-compose-for-local-django-development-replacing-virtualenv/
# Notes:
#    * 'image' is a reference to a DockerHub location e.g.
#      cheewai/postgis refers to https://hub.docker.com/r/cheewai/postgis/
#    * if all containers are DISABLED, this file will throw an error!

postgresql:
    image: raymondmolapo/postgis
    container_name: ocims_postgis
    environment:
        - POSTGRES_DB=ckan_default
        - POSTGRES_USER=ckan_default
        - POSTGRES_PASSWORD=ckan
    volumes:
        - ~/dev/ocims/postgresql/data/:/var/lib/postgresql/data
        # Customize access control to overwrite the default
        #- ~/dev/ocims/postgresql/pg_hba.conf:/var/lib/postgresql/data/pg_hba.conf:ro
        # Customize server tuning parameters to overwrite the default
        #- ~/dev/ocims/postgresql/postgresql.conf:/var/lib/postgresql/data/postgresql.conf:ro
    ports:
        - "5431:5432"


tomcat:
    image: tomcat:8-jre8
    container_name: ocims_tomcat
    volumes:
        - ~/dev/ocims/tomcat/webapps/:/usr/local/tomcat/webapps/
    ports:
        - "8081:8080"


solr:
    image: solr:5.3.2
    container_name: ocims_solr
    # command used to trigger create:
    # https://github.com/docker-solr/docker-solr/blob/master/5.3/scripts/docker-entrypoint.sh
    command: solr-precreate ckan /var/solr/data/configsets/ckan/
    #environment:
    #    - CKAN_POSTGRESQL_PASSWORD
    # mount in schema, see: 
    # http://docs.ckan.org/en/latest/maintaining/installing/install-from-source.html#setup-solr
    volumes:
        - ~/solr/backup/:/solr/backup/
        - ~/dev/ocims/ckan/:/var/solr/data/configsets/ckan/
        - jts-1.13.jar:/opt/solr/server/lib/jts-1.13.jar
    #    - ~/dev/ocims/solr/:/usr/local/solr/webapps/
    ports:
        - "8981:8983"


ckan:
    build: ckan
    container_name: ocims_ckan
    #command:
    #    /usr/sbin/apache2ctl -D FOREGROUND
    volumes:
        - ~/dev/ocims/ckan/scripts/:/scripts
        - ~/dev/ocims/ckan/conf/schema.xml:/usr/lib/ckan/default/src/ckan/ckan/config/solr/schema.xml
    # Note: must set by -  export CKAN_POSTGRESQL_PASSWORD="foo"
    environment:
        - CKAN_POSTGRESQL_PASSWORD=$CKAN_POSTGRESQL_PASSWORD
    ports:
        - "80:80"

